<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>What's the Link? — 链接预览</title>
<style>
  body{background:#0e1117;color:#e9eef5;font-family:system-ui;padding:30px;margin:0}
  .container{max-width:900px;margin:0 auto}
  h1{margin:0;font-size:26px}
  .lead{margin:8px 0 20px;color:#97a0b3}
  input,button{padding:10px 14px;border-radius:8px;font-size:14px;border:none}
  input{flex:1;background:#1b1f27;color:#e9eef5}
  button{background:#4fd1c5;color:#042022;font-weight:600;cursor:pointer}
  button.secondary{background:#2c313d;color:#a6aec3}
  form{display:flex;gap:8px;margin-bottom:20px}
  .card{background:#151a21;padding:20px;border-radius:12px;margin-top:20px}
  .meta-row{display:flex;flex-wrap:wrap;gap:12px;margin-top:8px;color:#97a0b3;font-size:13px}
  .label span{color:#e9eef5}
  .thumbs{display:flex;flex-wrap:wrap;gap:10px;margin-top:15px}
  .thumb{width:150px;height:90px;background:#0f131a;border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden;cursor:pointer}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .alert{background:#1b1f27;padding:12px;border-left:4px solid #4fd1c5;border-radius:6px;margin-top:12px;display:none}
  .alert.error{border-left-color:#ff6b6b}
  pre{background:#0d1117;color:#b8c7d9;padding:10px;border-radius:8px;font-size:12px;overflow:auto;max-height:200px}
  .big-modal{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:9999}
  .big-modal.open{display:flex}
  .big-modal img{max-width:95%;max-height:90%;border-radius:10px}
</style>
</head>

<body>
<div class="container">

<h1>What's the Link? — 链接预览</h1>
<div class="lead">输入磁力链接 / DDL / BT / ED2K，显示 whatslink.info 提供的文件信息与预览图</div>

<form onsubmit="return false;">
  <input id="inputUrl" placeholder="输入 magnet:?xt= 或 https:// 链接" />
  <button id="btnQuery">查询</button>
  <button id="btnSample" class="secondary">示例</button>
</form>

<div id="status" class="alert"></div>

<div id="result" class="card" style="display:none;">
  <div class="big" id="resName" style="font-size:18px;font-weight:700;">—</div>

  <div class="meta-row">
    <div class="label">类型：<span id="resType">—</span></div>
    <div class="label">文件类别：<span id="resFileType">—</span></div>
    <div class="label">文件数：<span id="resCount">—</span></div>
    <div class="label">大小：<span id="resSize">—</span></div>
  </div>

  <div style="margin-top:10px;">
    <button id="btnCopy" class="secondary">复制原始链接</button>
    <a href="https://whatslink.info" target="_blank" style="color:#4fd1c5;margin-left:12px;">数据来自 whatslink.info</a>
  </div>

  <h3 style="color:#97a0b3;margin-top:18px;font-size:14px;">预览截图</h3>
  <div id="thumbs" class="thumbs"></div>
</div>

</div>

<!-- 大图查看 -->
<div id="modal" class="big-modal" onclick="closeModal()">
  <img id="modalImg" src="">
</div>

<script>
const api = "https://whatslink.info/api/v1/link";

function $(id){return document.getElementById(id);}

$("btnSample").onclick = ()=> {
  $("inputUrl").value = "magnet:?xt=urn:btih:EXAMPLE_HASH&dn=example";
};

$("btnQuery").onclick = async ()=> {
  const url = $("inputUrl").value.trim();
  if(!url) return showStatus("请输入链接", true);

  clearResult();
  showStatus("查询中…");

  try {
    const r = await fetch(api + "?url=" + encodeURIComponent(url));
    if(!r.ok) throw new Error("HTTP " + r.status);

    const data = await r.json();
    render(data, url);
    showStatus("");
  } catch (e) {
    if (e.message.includes("Failed to fetch")) {
      showStatus("无法访问 API，可能是 CORS 限制。建议使用你自己的后端代理。", true);
    } else {
      showStatus("查询失败：" + e.message, true);
    }
  }
};

$("btnCopy").onclick = ()=> {
  const url = $("inputUrl").value.trim();
  if (!url) return;
  navigator.clipboard.writeText(url);
  showStatus("已复制链接");
};

function showStatus(msg, isErr=false){
  const el = $("status");
  if(!msg){ el.style.display="none"; return; }
  el.style.display="block";
  el.textContent = msg;
  el.className = "alert" + (isErr ? " error" : "");
}

function clearResult(){ $("result").style.display="none"; }

function render(data, originalUrl){
  $("result").style.display="";
  $("resName").textContent = data.name || "未命名";
  $("resType").textContent = data.type || "—";
  $("resFileType").textContent = data.file_type || "—";
  $("resCount").textContent = data.count ?? "—";
  $("resSize").textContent = formatBytes(data.size) || "—";

  // -------------------------------------
  // screenshots 强兼容处理
  // -------------------------------------
  const thumbs = $("thumbs");
  thumbs.innerHTML = "";

  const arr = Array.isArray(data.screenshots) ? data.screenshots : [];

  arr.forEach((src, i) => {
    let imageUrl = null;

    // ① 字符串格式
    if (typeof src === 'string') {
        imageUrl = src;
    }

    // ② 对象格式：{ screenshot: "..."}
    else if (src && typeof src === 'object') {

        // 优先使用官方字段 screenshot
        if (typeof src.screenshot === 'string') {
            imageUrl = src.screenshot;
        }
        // 次选：{ url: "..." }
        else if (typeof src.url === 'string') {
            imageUrl = src.url;
        }
    }

    const d = document.createElement('div');
    d.className = 'thumb';

    if (imageUrl) {
        const img = document.createElement('img');
        img.alt = `screenshot-${i + 1}`;
        img.src = imageUrl;
        img.loading = 'lazy';
        d.appendChild(img);

        d.addEventListener('click', (e) => {
            openModal(imageUrl);
            e.stopPropagation();
        });

    } else {
        d.textContent = '无图';
    }

    thumbs.appendChild(d);
});

  $("jsonPre").textContent = JSON.stringify(data, null, 2);
}

function formatBytes(bytes){
  if (typeof bytes !== "number") return bytes;
  const units=["B","KB","MB","GB","TB"];
  let i = Math.floor(Math.log(bytes)/Math.log(1024));
  return (bytes/Math.pow(1024,i)).toFixed(2)+" "+units[i];
}

function openModal(src){
  $("modalImg").src = src;
  $("modal").classList.add("open");
}
function closeModal(){
  $("modal").classList.remove("open");
  $("modalImg").src = "";
}
</script>
</body>
</html>